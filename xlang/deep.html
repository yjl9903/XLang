<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>原理和设计 | XLang</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="A Simple Programming Language Powered by XLex and XParse.">
    
    <link rel="preload" href="/assets/css/0.styles.680745fd.css" as="style"><link rel="preload" href="/assets/js/app.f5e6def7.js" as="script"><link rel="preload" href="/assets/js/2.8b492b7e.js" as="script"><link rel="preload" href="/assets/js/15.80d5cc20.js" as="script"><link rel="prefetch" href="/assets/js/10.bd9d8196.js"><link rel="prefetch" href="/assets/js/11.56940f5c.js"><link rel="prefetch" href="/assets/js/12.120d72ef.js"><link rel="prefetch" href="/assets/js/13.9d3123d5.js"><link rel="prefetch" href="/assets/js/14.4b9bbd83.js"><link rel="prefetch" href="/assets/js/16.9a2bf8b9.js"><link rel="prefetch" href="/assets/js/17.1bfb87bc.js"><link rel="prefetch" href="/assets/js/18.9def0742.js"><link rel="prefetch" href="/assets/js/19.8275e46b.js"><link rel="prefetch" href="/assets/js/20.a1fca922.js"><link rel="prefetch" href="/assets/js/21.88a55443.js"><link rel="prefetch" href="/assets/js/22.7ecc4734.js"><link rel="prefetch" href="/assets/js/23.546db149.js"><link rel="prefetch" href="/assets/js/3.dd66873b.js"><link rel="prefetch" href="/assets/js/4.a7f51ca2.js"><link rel="prefetch" href="/assets/js/5.44f1ea06.js"><link rel="prefetch" href="/assets/js/6.962ff319.js"><link rel="prefetch" href="/assets/js/7.25da0c18.js"><link rel="prefetch" href="/assets/js/8.9dda87bb.js"><link rel="prefetch" href="/assets/js/9.2ff73d2a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.680745fd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">XLang</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/xlang/" class="nav-link router-link-active">
  XLang
</a></div><div class="nav-item"><a href="/xlex/" class="nav-link">
  XLex
</a></div><div class="nav-item"><a href="/xparse/" class="nav-link">
  XParse
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/xlang/" class="nav-link router-link-active">
  XLang
</a></div><div class="nav-item"><a href="/xlex/" class="nav-link">
  XLex
</a></div><div class="nav-item"><a href="/xparse/" class="nav-link">
  XParse
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>XLang</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xlang/" aria-current="page" class="sidebar-link">XLang 介绍</a></li><li><a href="/xlang/syntax.html" class="sidebar-link">语法</a></li><li><a href="/xlang/fn.html" class="sidebar-link">内置函数</a></li><li><a href="/xlang/examples.html" class="sidebar-link">示例</a></li><li><a href="/xlang/deep.html" aria-current="page" class="active sidebar-link">原理和设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/xlang/deep.html#抽象语法树" class="sidebar-link">抽象语法树</a></li><li class="sidebar-sub-header"><a href="/xlang/deep.html#三地址码" class="sidebar-link">三地址码</a></li><li class="sidebar-sub-header"><a href="/xlang/deep.html#虚拟机" class="sidebar-link">虚拟机</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>XLex</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>XParse</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他应用</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="抽象语法树"><a href="#抽象语法树" class="header-anchor">#</a> 抽象语法树</h2> <p>在使用 XParse 进行 LR 分析时，通过计算综合属性的方式求出抽象语法树。</p> <p>使用一个类 <code>BasicASTNode</code> 定义了抽象语法树结点的基类，拥有虚函数 <code>visit(context: Context): NodeVisitorReturn</code>。</p> <p>有具体抽象语法树结点：</p> <ul><li><p><code>RootASTNode</code>：程序根结点；</p></li> <li><p><code>FunctionASTNode</code>：函数定义结点；</p></li> <li><p><code>StatementListASTNode</code>：程序语句列表结点；</p></li> <li><p><code>IfStatementASTNode</code>：<code>if</code> 语句结点；</p></li> <li><p><code>WhileStatementASTNode</code>：<code>while</code> 语句结点；</p></li> <li><p><code>ForStatementASTNode</code>：<code>for</code> 语句结点；</p></li> <li><p><code>DefineListASTNode</code>：变量声明语句列表结点；</p></li> <li><p><code>DefineASTNode</code>：变量声明；</p></li> <li><p><code>ArgDefineListASTNode</code>：函数参数列表结点；</p></li> <li><p><code>LeafASTNode</code>：具体变量或常量值结点；</p></li> <li><p><code>BinOPASTNode</code>：二元操作符结点；</p></li> <li><p><code>UnitOPASTNode</code>：一元操作符结点。</p></li> <li><p><code>FunctionCallASTNode</code>：函数调用语句结点；</p></li> <li><p><code>FunctionReturnASTNode</code>：函数返回语句结点。</p></li></ul> <p>这些结点均实现了在遍历抽象语法树的递归访问函数 <code>visit(context: Context): NodeVisitorReturn</code>，其中 <code>context</code> 包含当前访问位置的上下文信息，包含符号表，全局函数和当前编译的函数。</p> <p>为了实现作用域的切换，符号表形成了一个链表的结构，每个作用域的符号表有一个指针指向上层符号表，每个符号表使用一个哈希表实现。在查询具体符号时，会在当前作用域中的哈希表查找，若找不到会继续在上层递归查找。符号表的具体实现见 <a href="https://github.com/yjl9903/XLang/blob/master/src/xlang/symbolTable.ts" target="_blank" rel="noopener noreferrer">symbolTable.ts<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>访问函数都会返回一个对象，包含两个属性。<code>code</code> 属性存放当前结点生成出来的代码，<code>dst</code> 属性存放这个结点返回值的变量或常量信息，包含它的类型，内存相对地址等信息。</p> <h2 id="三地址码"><a href="#三地址码" class="header-anchor">#</a> 三地址码</h2> <p>XLang 的三地址码支持以下指令：</p> <p><code>NOP</code>，<code>FunctionCall</code>，<code>FunctionReturn</code>，<code>PushStack</code>，<code>Goto</code>，<code>IfGoto</code>，<code>Plus</code>，<code>Minus</code>，<code>Mul</code>，<code>Div</code>，<code>Mod</code>，<code>Negative</code>，<code>Not</code>，<code>And</code>，<code>Or</code>，<code>NotEqual</code>，<code>Equal</code>，<code>LessThan</code>，<code>MoreThan</code>，<code>LessOrEqual</code>，<code>MoreOrEqual</code>，<code>Assign</code>。</p> <p>更详细和完整的三地址码类型定义见 <a href="https://github.com/yjl9903/XLang/blob/master/src/xlang/tac.ts" target="_blank" rel="noopener noreferrer">tac.ts<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，以及类型推断的定义。</p> <p>这些三地址码指令可以分为 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.557ex" viewBox="0 -666 500 688" style="vertical-align:-0.05ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path></g></g></g></svg></mjx-container> 类。</p> <ul><li><p>函数调用相关：<code>FunctionCall</code>，<code>FunctionReturn</code> 处理函数调用，<code>PushStack</code> 处理函数参数的传递；</p></li> <li><p>控制流跳转：<code>Goto</code>，<code>IfGoto</code>；</p></li> <li><p>数值计算相关：<code>Plus</code>，<code>Minus</code> 等；</p></li> <li><p>内存赋值：<code>Assign</code>；</p></li> <li><p>空操作：<code>NOP</code>。</p></li></ul> <h2 id="虚拟机"><a href="#虚拟机" class="header-anchor">#</a> 虚拟机</h2> <p>虚拟机维护了当前要执行的三地址码位置，全局变量，函数调用栈，存储局部变量的栈。</p> <p>在函数调用的过程中，维护了函数的调用栈，包含上层函数的现场信息（栈指针，程序指令指针，调用函数名等），还维护了局部变量的内存栈（如下图所示）。</p> <center><img src="/stack.png" alt="stack"></center> <p>栈指针指向了当前函数调用的局部变量最低地址，而栈指针前存放的是调用这个函数传进来的实际参数。</p> <p>在函数调用前，使用 <code>PushStack</code> 指令将参数传入调用函数。</p> <p>对于控制流指令，使用相对地址进行跳转。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/xlang/examples.html" class="prev">
        示例
      </a></span> <span class="next"><a href="/xlex/">
        XLex 介绍
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f5e6def7.js" defer></script><script src="/assets/js/2.8b492b7e.js" defer></script><script src="/assets/js/15.80d5cc20.js" defer></script>
  </body>
</html>
